<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Gateway Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div x-data="mcpAdmin()" x-init="init()" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">ğŸ”Œ MCP Gateway Dashboard</h1>
                    <p class="text-gray-600 mt-2">Manage your Home Assistant & N8N connections</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div :class="healthStatus === 'healthy' ? 'bg-green-500' : 'bg-red-500'" 
                             class="w-3 h-3 rounded-full mr-2"></div>
                        <span class="text-sm font-medium" x-text="healthStatus"></span>
                    </div>
                    <button @click="refreshData()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        ğŸ”„ Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Authentication Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ” Authentication & URLs</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800">Gateway URL</h3>
                    <code class="text-sm bg-white p-2 rounded block mt-2" x-text="gatewayUrl"></code>
                    <button @click="copyToClipboard(gatewayUrl)" 
                            class="mt-2 text-blue-600 hover:text-blue-800 text-sm">ğŸ“‹ Copy</button>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-800">Access Token</h3>
                    <code class="text-sm bg-white p-2 rounded block mt-2" x-text="accessToken ? accessToken.substring(0, 20) + '...' : 'Click to generate'"></code>
                    <button @click="generateToken()" 
                            class="mt-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                        ğŸ”‘ Generate Token
                    </button>
                </div>
            </div>
        </div>

        <!-- Available Tools -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ› ï¸ Available MCP Tools</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Home Assistant Tools -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center mb-3">
                        <span class="text-2xl mr-2">ğŸ </span>
                        <h3 class="font-semibold">Home Assistant Tools</h3>
                    </div>
                    <div class="space-y-2">
                        <template x-for="tool in homeAssistantTools" :key="tool.name">
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="font-medium" x-text="tool.name"></div>
                                <div class="text-sm text-gray-600" x-text="tool.description"></div>
                                <div class="text-xs text-blue-600 mt-1" x-text="tool.category"></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- N8N Tools -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center mb-3">
                        <span class="text-2xl mr-2">âš¡</span>
                        <h3 class="font-semibold">N8N Tools</h3>
                    </div>
                    <div class="space-y-2">
                        <template x-for="tool in n8nTools" :key="tool.name">
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="font-medium" x-text="tool.name"></div>
                                <div class="text-sm text-gray-600" x-text="tool.description"></div>
                                <div class="text-xs text-purple-600 mt-1" x-text="tool.category"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š Connection Status</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-blue-800">Home Assistant</h3>
                            <p class="text-sm text-blue-600" x-text="homeAssistantStatus"></p>
                        </div>
                        <div :class="homeAssistantConnected ? 'text-green-500' : 'text-red-500'" 
                             class="text-2xl">
                            <span x-text="homeAssistantConnected ? 'âœ…' : 'âŒ'"></span>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-600" x-show="homeAssistantEntities">
                        <span x-text="homeAssistantEntities"></span> entities
                    </div>
                </div>

                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-purple-800">N8N</h3>
                            <p class="text-sm text-purple-600" x-text="n8nStatus"></p>
                        </div>
                        <div :class="n8nConnected ? 'text-green-500' : 'text-red-500'" 
                             class="text-2xl">
                            <span x-text="n8nConnected ? 'âœ…' : 'âŒ'"></span>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-600" x-show="n8nWorkflows">
                        <span x-text="n8nWorkflows"></span> workflows
                    </div>
                </div>

                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-green-800">Gateway</h3>
                            <p class="text-sm text-green-600" x-text="gatewayStatus"></p>
                        </div>
                        <div :class="gatewayConnected ? 'text-green-500' : 'text-red-500'" 
                             class="text-2xl">
                            <span x-text="gatewayConnected ? 'âœ…' : 'âŒ'"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Tools -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ§ª Test Tools</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-3">
                    <h3 class="font-semibold">Home Assistant Tests</h3>
                    <button @click="testHomeAssistant('get_states')" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        Test Get States
                    </button>
                    <button @click="testHomeAssistant('get_entities', {domain: 'light'})" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        Test Get Lights
                    </button>
                </div>
                <div class="space-y-3">
                    <h3 class="font-semibold">N8N Tests</h3>
                    <button @click="testN8N('list_workflows')" 
                            class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                        Test List Workflows
                    </button>
                    <button @click="testN8N('get_executions')" 
                            class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                        Test Get Executions
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div x-show="testResult" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ Test Results</h2>
            <pre class="bg-gray-100 p-4 rounded-lg overflow-x-auto text-sm" x-text="testResult"></pre>
        </div>
    </div>

    <script>
        function mcpAdmin() {
            return {
                healthStatus: 'checking...',
                gatewayUrl: window.location.origin.replace(':3001', ':3000'),
                accessToken: localStorage.getItem('mcpAccessToken'),
                homeAssistantConnected: false,
                n8nConnected: false,
                gatewayConnected: false,
                homeAssistantStatus: 'Checking...',
                n8nStatus: 'Checking...',
                gatewayStatus: 'Checking...',
                homeAssistantEntities: 0,
                n8nWorkflows: 0,
                homeAssistantTools: [],
                n8nTools: [],
                testResult: '',

                async init() {
                    this.setupGatewayUrl();
                    await this.checkHealth();
                    await this.loadTools();
                    await this.checkConnections();
                },

                setupGatewayUrl() {
                    // Try to detect if we're running on Cloudflare
                    if (window.location.hostname.includes('trycloudflare.com')) {
                        // Extract base URL and use for gateway
                        this.gatewayUrl = window.location.origin.replace('3001', '3000');
                    }
                },

                async checkHealth() {
                    try {
                        const response = await fetch(`${this.gatewayUrl}/health`);
                        const data = await response.json();
                        this.healthStatus = data.status;
                        this.gatewayConnected = data.status === 'healthy';
                        this.gatewayStatus = 'Connected';
                    } catch (error) {
                        this.healthStatus = 'unhealthy';
                        this.gatewayStatus = 'Disconnected';
                        this.gatewayConnected = false;
                    }
                },

                async generateToken() {
                    try {
                        const response = await fetch(`${this.gatewayUrl}/api/auth/oauth/callback`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: 'demo_code', state: 'demo_state' })
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.accessToken = data.accessToken;
                            localStorage.setItem('mcpAccessToken', this.accessToken);
                        }
                    } catch (error) {
                        alert('Failed to generate token');
                    }
                },

                async loadTools() {
                    // Define tools based on our adapters
                    this.homeAssistantTools = [
                        { name: 'get_states', description: 'Get states of all entities or specific entity', category: 'state' },
                        { name: 'call_service', description: 'Call a Home Assistant service', category: 'control' },
                        { name: 'get_entities', description: 'List all available entities by domain', category: 'discovery' },
                        { name: 'get_services', description: 'Get available services', category: 'discovery' },
                        { name: 'trigger_automation', description: 'Trigger a Home Assistant automation', category: 'automation' },
                        { name: 'set_state', description: 'Set entity state and attributes', category: 'state' },
                        { name: 'get_history', description: 'Get entity history', category: 'history' }
                    ];

                    this.n8nTools = [
                        { name: 'list_workflows', description: 'List all available workflows', category: 'workflows' },
                        { name: 'execute_workflow', description: 'Execute a workflow manually', category: 'execution' },
                        { name: 'get_workflow', description: 'Get workflow details', category: 'workflows' },
                        { name: 'activate_workflow', description: 'Activate or deactivate a workflow', category: 'management' },
                        { name: 'get_executions', description: 'Get workflow execution history', category: 'execution' },
                        { name: 'get_execution', description: 'Get specific execution details', category: 'execution' },
                        { name: 'create_workflow', description: 'Create a new workflow', category: 'workflows' },
                        { name: 'update_workflow', description: 'Update an existing workflow', category: 'workflows' },
                        { name: 'webhook_trigger', description: 'Trigger a workflow via webhook', category: 'webhooks' }
                    ];
                },

                async checkConnections() {
                    // Check Home Assistant
                    try {
                        const haResponse = await fetch('https://ha.right-api.com/api/', {
                            headers: { 'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiIwMzdmMDk3ZDliODg0MmVhOWNlYWU5NDM2NTNkZGNhMCIsImlhdCI6MTc1MDg0MTI2MywiZXhwIjoyMDY2MjAxMjYzfQ.ZfJNVVfOyuVp8ff4pYG-aQJFw7RZvQCt2DiPtp5wAdM' }
                        });
                        this.homeAssistantConnected = haResponse.ok;
                        this.homeAssistantStatus = this.homeAssistantConnected ? 'Connected' : 'Failed';
                        
                        if (this.homeAssistantConnected) {
                            const statesResponse = await fetch('https://ha.right-api.com/api/states', {
                                headers: { 'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiIwMzdmMDk3ZDliODg0MmVhOWNlYWU5NDM2NTNkZGNhMCIsImlhdCI6MTc1MDg0MTI2MywiZXhwIjoyMDY2MjAxMjYzfQ.ZfJNVVfOyuVp8ff4pYG-aQJFw7RZvQCt2DiPtp5wAdM' }
                            });
                            const states = await statesResponse.json();
                            this.homeAssistantEntities = states.length;
                        }
                    } catch (error) {
                        this.homeAssistantConnected = false;
                        this.homeAssistantStatus = 'Error';
                    }

                    // Check N8N
                    try {
                        const n8nResponse = await fetch('https://app.right-api.com/api/v1/workflows', {
                            headers: { 'X-N8N-API-KEY': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIyODQwYzIzMC04NTE4LTRhZWEtYmM4OC0zNTk1MjhiMDQ5MDgiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzUxNzkyMDAzfQ.8oJQkuLWf_KjQ9rRzr1PavGMUpW6T5C6rsvRnmyOysA' }
                        });
                        this.n8nConnected = n8nResponse.ok;
                        this.n8nStatus = this.n8nConnected ? 'Connected' : 'Failed';
                        
                        if (this.n8nConnected) {
                            const workflows = await n8nResponse.json();
                            this.n8nWorkflows = workflows.data?.length || 0;
                        }
                    } catch (error) {
                        this.n8nConnected = false;
                        this.n8nStatus = 'Error';
                    }
                },

                async testHomeAssistant(method, params = {}) {
                    if (!this.accessToken) {
                        await this.generateToken();
                    }
                    
                    try {
                        const response = await fetch(`${this.gatewayUrl}/api/mcp/rpc`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.accessToken}`
                            },
                            body: JSON.stringify({
                                jsonrpc: '2.0',
                                method: method,
                                params: params,
                                id: 1
                            })
                        });
                        const result = await response.json();
                        this.testResult = JSON.stringify(result, null, 2);
                    } catch (error) {
                        this.testResult = `Error: ${error.message}`;
                    }
                },

                async testN8N(method, params = {}) {
                    if (!this.accessToken) {
                        await this.generateToken();
                    }
                    
                    try {
                        const response = await fetch(`${this.gatewayUrl}/api/mcp/rpc`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.accessToken}`
                            },
                            body: JSON.stringify({
                                jsonrpc: '2.0',
                                method: method,
                                params: params,
                                id: 1
                            })
                        });
                        const result = await response.json();
                        this.testResult = JSON.stringify(result, null, 2);
                    } catch (error) {
                        this.testResult = `Error: ${error.message}`;
                    }
                },

                async refreshData() {
                    await this.checkHealth();
                    await this.checkConnections();
                },

                copyToClipboard(text) {
                    navigator.clipboard.writeText(text).then(() => {
                        alert('Copied to clipboard!');
                    });
                }
            }
        }
    </script>
</body>
</html>